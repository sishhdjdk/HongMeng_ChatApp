/**
 * ä¸Žå®žä¹ è€å¸ˆï¼ˆçŽ‹è€å¸ˆï¼‰èŠå¤©é¡µ
 * åŠŸèƒ½ï¼šæ˜¾ç¤ºä¸Žå®žä¹ è€å¸ˆçš„èŠå¤©è®°å½•
 */
import router from '@ohos.router'

class ChatMessage {
  id: number
  isSelf: boolean
  content: string
  time: string

  constructor(id: number, isSelf: boolean, content: string, time: string) {
    this.id = id
    this.isSelf = isSelf
    this.content = content
    this.time = time
  }
}

@Entry
@Component
struct Chat_InternTeacher {
  @State inputText: string = ''
  @State canSend: boolean = false
  @State messageList: ChatMessage[] = [
    new ChatMessage(1, true, 'çŽ‹è€å¸ˆï¼Œä»Šå¤©è·Ÿç€æ‚¨è·‘å¸‚åœºï¼Œå­¦åˆ°å¥½å¤šä¸œè¥¿ï¼Œå°±æ˜¯ä¸‹åˆèµ°å¤ªå¤šè·¯ï¼Œæˆ‘çš„è¿åŠ¨éž‹éƒ½å¿«ç£¨ç ´äº†ï¼Œçœ‹æ¥å¾—ä¹°åŒ"å®žä¹ ä¸“ç”¨éž‹"äº†ã€‚', '17:20'),
    new ChatMessage(2, false, 'å“ˆå“ˆï¼Œåˆšå¼€å§‹éƒ½è¿™æ ·ï¼Œæˆ‘å½“å¹´å®žä¹ ä¹Ÿæ˜¯å¤©å¤©æš´èµ°ï¼ŒåŽæ¥ç›´æŽ¥å›¤äº†ä¸¤åŒè¿åŠ¨éž‹æ¢ç€ç©¿ã€‚å¯¹äº†ï¼Œä»Šå¤©çš„å¸‚åœºæŠ¥å‘Šè®°å¾—æ•´ç†ä¸‹ï¼Œæ˜Žå¤©ä¸Šç­å‰å‘ç»™æˆ‘ï¼Œä¸éš¾ï¼Œåˆ«ç´§å¼ ã€‚', '17:25'),
    new ChatMessage(3, true, 'å¥½çš„è€å¸ˆï¼æˆ‘ä»Šæ™šä¸€å®šæ•´ç†å¥½ï¼Œäº‰å–ä¸åŠ ç­ï¼Œä¿ä½æˆ‘çš„"è¿åŠ¨éž‹å¯¿å‘½"ï½ž', '17:27'),
    new ChatMessage(4, false, 'æ²¡é—®é¢˜ï¼Œæœ‰ä¸æ‡‚çš„éšæ—¶é—®æˆ‘ï¼Œåˆ«ç¡¬æ’‘ï¼Œå’±ä»¬å®žä¹ æ˜¯å­¦ä¸œè¥¿ï¼Œä¸æ˜¯"æ‹¼éž‹"ï¼', '17:30'),
  ]
  private scroller: Scroller = new Scroller()

  checkCanSend(value: string) {
    this.canSend = value.trim().length > 0
  }

  sendMessage() {
    if (this.canSend) {
      const newMessage = new ChatMessage(
        this.messageList.length + 1,
        true,
        this.inputText,
        'åˆšåˆš'
      )
      this.messageList.push(newMessage)
      this.inputText = ''
      this.canSend = false

      setTimeout(() => {
        this.scroller.scrollEdge(Edge.Bottom)
      }, 100)
    }
  }

  @Builder
  MessageBubble(message: ChatMessage) {
    Row() {
      if (message.isSelf) {
        Blank()
      }

      Column() {
        Text(message.time)
          .fontSize(12)
          .fontColor('#999999')
          .margin({ bottom: 8 })

        Row() {
          if (!message.isSelf) {
            Text('çŽ‹')
              .width(40)
              .height(40)
              .borderRadius(4)
              .backgroundColor('#07C160')
              .fontColor('#FFFFFF')
              .fontSize(16)
              .textAlign(TextAlign.Center)
              .margin({ right: 8 })
          }

          Text(message.content)
            .fontSize(16)
            .fontColor(message.isSelf ? '#FFFFFF' : '#000000')
            .backgroundColor(message.isSelf ? '#07C160' : '#FFFFFF')
            .padding(12)
            .borderRadius(8)
            .maxLines(100)
            .constraintSize({ maxWidth: '60%' })

          if (message.isSelf) {
            Text('æˆ‘')
              .width(40)
              .height(40)
              .borderRadius(4)
              .backgroundColor('#576B95')
              .fontColor('#FFFFFF')
              .fontSize(16)
              .textAlign(TextAlign.Center)
              .margin({ left: 8 })
          }
        }
        .alignItems(VerticalAlign.Top)
      }
      .alignItems(message.isSelf ? HorizontalAlign.End : HorizontalAlign.Start)

      if (!message.isSelf) {
        Blank()
      }
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 8, bottom: 8 })
  }

  build() {
    Column() {
      Row() {
        Image($r('sys.media.ohos_ic_public_arrow_left'))
          .width(24)
          .height(24)
          .onClick(() => {
            router.back()
          })

        Text('å®žä¹ è€å¸ˆï¼ˆçŽ‹è€å¸ˆï¼‰')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .margin({ left: 16 })
          .layoutWeight(1)

        Image($r('sys.media.ohos_ic_public_more'))
          .width(24)
          .height(24)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#FFFFFF')
      .border({ width: { bottom: 1 }, color: '#EDEDED' })

      if (this.messageList.length > 0) {
        List({ scroller: this.scroller }) {
          ForEach(this.messageList, (message: ChatMessage) => {
            ListItem() {
              this.MessageBubble(message)
            }
          })
        }
        .width('100%')
        .layoutWeight(1)
        .backgroundColor('#EDEDED')
      } else {
        Column() {
          Text('æš‚æ— æ¶ˆæ¯')
            .fontSize(16)
            .fontColor('#999999')
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .backgroundColor('#EDEDED')
      }

      Row() {
        Image($r('sys.media.ohos_ic_public_voice'))
          .width(28)
          .height(28)
          .margin({ right: 8 })

        TextInput({ text: this.inputText, placeholder: 'è¯·è¾“å…¥æ¶ˆæ¯' })
          .layoutWeight(1)
          .height(36)
          .fontSize(16)
          .backgroundColor('#F5F5F5')
          .borderRadius(4)
          .onChange((value: string) => {
            this.inputText = value
            this.checkCanSend(value)
          })

        Text('ðŸ˜Š')
          .fontSize(24)
          .margin({ left: 8, right: 8 })

        Image($r('sys.media.ohos_ic_public_add'))
          .width(28)
          .height(28)
          .margin({ right: 8 })

        Button('å‘é€')
          .fontSize(14)
          .fontColor('#FFFFFF')
          .backgroundColor(this.canSend ? '#07C160' : '#CCCCCC')
          .height(36)
          .borderRadius(4)
          .enabled(this.canSend)
          .onClick(() => {
            this.sendMessage()
          })
      }
      .width('100%')
      .padding(12)
      .backgroundColor('#FFFFFF')
      .border({ width: { top: 1 }, color: '#EDEDED' })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#EDEDED')
  }
}

